Personal Zone Hub Administration
================================

{{toc}}

In this section we cover functionality provided by a Personal Zone Hub (PZH) to manage the devices in a personal zone. PZH functionality is accessible via a Web site hosted on a Web Server as part of the PZH. The Web Server is an interface for the users to make the device be part of the personal zone. It is a front end for back-end functionality provided by the PZH TLS Server, which performs all the PZH internal functionality and is covered in the "PZH":http://dev.webinos.org/redmine/projects/wp3-3/wiki/PZH_Introduction section.

This section covers the following features of the PZH Web Server to support the PZH Administration functionality:

-   Device Enrollment
-   PZP Revocation
-   PZH Export and Import
-   User to personal zone discovery and binding
-   User preferences option

All of these features are provided to help the user remotely manage their devices and facilitate communication between the devices.

Device Enrollment
-----------------

When a Personal Zone Proxy (PZP) is first installed (or when pre-installed on a device) it is considered to be in the "Virgin mode": i.e. the device has not joined any personal zone and is not connected to a personal zone hub. Registering the device within the personal zone allows the device to communicate with the owner’s PZH, other PZHs belonging to the other users, and other PZPs in the personal zone. PZP enrolment is the process of adding a new PZP to the personal zone for the first time.

Enrolling results in the PZP obtaining the signed certificate from the PZH CA and a copy of the PZH’s master CA certificate. Certificate generation by the PZH for the PZP is covered in the "Personal Zone Key Infrastructure":http://dev.webinos.org/redmine/projects/wp3-3/wiki/Personal_Zone_Key_Infrastructure section.

Enrolling the device can be done via the PZH web interface or via the PZP, both of which are defined below.

Both approaches rely on the user’s chosen PZH generating an _authentication token_: a short text string with a limited validity period, also defined in the "Personal Zone Key Infrastructure":http://dev.webinos.org/redmine/projects/wp3-3/wiki/Personal_Zone_Key_Infrastructure section.

### Manual token entry

The PZH web interface can be used to generate an authentication token. Once the token is generated by the PZH, the user then enters it into an interface provided by the PZP along with connection details (the URL) for the user’s PZH.

The PZP then attempts to connect to the PZH using the JSONRPC+TLS channel defined in the [[PZP_Introduction|PZP Introduction] section. Self-signed certificates are used for this initial connection, and the PZH accepts them because it is expecting a new PZP to be enrolled. After connecting, the PZP then presents the PZH with the authentication token and a certificate signing request (CSR) for the PZP. The PZH compares the presented token to the token that it generated.

If they do not match, the PZH disconnects the PZP and decrements an internal counter for the validity of this token.

If they do match, signs the CSR, creating a valid X509 certificate and returns this to the PZP. The PZP disconnects and is then able to use its valid key hierarchy to connect to the PZH subsequently. The PZH also removes the token and stops accepting unauthenticated connections from PZPs as it is no longer expecting a new enrolment.

A state machine for the PZH during process is shown below. Note that only one PZP can be enrolled at any time, and that the PZH maintains an internal counter for the validity of each token as well as an expiry date. The token should be valid for a maximum of 10 minutes and only 5 attempts at guessing the token should be permitted by the hub. The token should be a string containing only integers, generated using 3+ bytes of secure random data. The generation of a new code should invalidate the old one.

![]({width:700px}http://dev.webinos.org/redmine/attachments/download/2523/pzh-pzpenroll.png)
Figure 1: PZH state machine showing transition during enrollment

The messages sent over the JSONRPC + TLS channel during enrolment are given below.

When the PZP attempts to connect to the PZH for the first time using an authentication code, it sends this message:

<pre class="javascript">
JSON:
{
 "type": "prop",
 "to": "pzh_id",
 "from": "pzp_id",
 "payload": {
 "status":"enrollPzp",
 "csr" : "", // PZP certificate signing request that it intends to get signed by the PZH
 "authCode": "",// authentication token
 }
}
</pre>

If the authentication token is accepted, the PZH responds with the following message:

<pre class="javascript">
JSON:
{
 "type": "prop",
 "from": "pzh_id",
 "to": "pzp_id", // pzp id provided in previous message
 "payload": {
 "status":"signedCert",
 "message":{
 "clientCert": "" , //signed PZP certificate
 "masterCert: "" // PZH master certificate
 }
 }
}
</pre>

### Browser Enrolment

Browser enrolment is a more automated approach to enrolling a PZP with a PZH which does not require the entry of an authentication token. The process requires the following steps:

1.  The user load an web interface provided by the PZP and either selects a PZH provider from a list or manually enters the desired PZH URL.
2.  The PZP opens this address and records the domain of the selected provider internally.
3.  The PZH authenticates the user through OpenID
4.  The OpenID process redirects the user back to the PZH web interface
    1.  If the user needs to create an account or register any more information with the PZH, this can happen here.

5.  The PZH redirects the user back to the PZP web interface, passing an authentication token and identifier for this PZH
6.  The PZP checks that the request came from the same domain as originally requested and that the PZH identifier is from this domain. It then prompts the user to confirm registration with this PZH.
7.  The PZP then attempts to use the authentication token as described in the previous ‘manual token entry’ section over the JSONRPC + TLS channel.
8.  If successful, the PZH returns the PZP a signed certificate

The following sequence diagram describes this process in more detail.

![](pzp_autoenrollment_v3.png)
Figure 2: PZH browser enrollment process

[andrÃ©] Don’t think that Browser should be part of this. Its the PZP. Also client/client.html is wrong here because this is just our WP4 implementation and should not be part of the spec. Also there are some messages exchanged on protocol level. So how do the look like? What needs the requestor provied? What does the receiver expect?

<span class="rev">. [Habib] browser changed to wrt as PZP enrollment does not happen in PZP but from WRT, removed client/client.html, added messages</span>

PZP enrolment involves certain messages exchanged between PZH and PZP, all communication is done over https. The

All communication from the PZP to the PZH uses following fields of https request.

|https option| Value|
|host| PZH address|
|port| 80|
|path| /index.html?cmd=pzpEnroll|
|method|POST|
|headers|Content-Length of the payload|

The body of the message differs for each message sent from the PZP to the PZH.

First message is the login message, sent to fetch Login page from the PZH provider.

<pre class="javascript">
JSON:
{
 "type": "prop",
 "to": "pzh_provider_address",
 "from":"pzp_id",
 "payload": {
 "status":"login",
 }
}
</pre>

The PZH responds back with the login page that it holds.

<pre class="javascript">
JSON:
{
 "type": "prop",
 "to": "pzp_id", // pzp id provided in previous message
 "from": "pzh_provider",
 "payload": {
 "status":"login",
 "url":"" // link to the pzh url page
 }
}
</pre>

Based on the user preferred OpenId a request is sent from the PZP to the PZH.

<pre class="javascript">
JSON:
{
 "type": "prop",
 "to": "pzh_provider_address",
 "from": "pzp_id",
 "payload": {
 "status":"authenticate",
 "provider":"google",
 "returnPath": "" // WRT page to redirect
 }
}
</pre>

On receiving this message, the PZH will authenticate user. After user authentication a redirection is done via the PZH to the PZP towards the return path specified in the previous message. Message is sent as a query message by the PZH.

<pre>
 "returnPath"? // return path is the field received in previous message
 cmd="authStatus"&
 status="online/offline"& // pzh exists or not-exists
 pzhid="pzh_provider/pzh_name"&
 auth_code= "authentication_token"
</pre>

In case PZH does not exists, auth_code is not generated. Above is the only message sent by the PZH as a query all other messages are sent in https body.

On receiving auth-status message, the PZP gets user consents depending on status field. If status is true then the PZH already exists and it asks user whether to enroll the PZP at the PZH address. If users agree then following message is sent by the PZP to the PZH.

<pre class="javascript">
JSON:
{
 "type": "prop",
 "to": "pzh_id",
 "from": "pzp_id",
 "payload": {
 "status":"enrollPzp",
 "csr" : "", // PZP csr certificate that it intends to get signed by the PZH
 "authCode": "",// authentication token received in previous message
 }
}
</pre>

The PZH then checks for authCode is similar to sent in auth-status message, if they match then it signs the CSR received from the PZP. After signing the PZP sends following message.

<pre class="javascript">
JSON:
{
 "type": "prop",
 "from": "pzh_id",
 "to": "pzp_id",
 "payload": {
 "status":"signedCert",
 "message":{
 "clientCert": "" , //signed PZP certificate
 "masterCert: "" // PZH master certificate
 }
 }
}
</pre>

In auth-status message, if status is false, it asks for user consent whether to create a PZH.

<pre class="javascript">
JSON:
{
 "type": "prop",
 "to": "pzh_id",
 "from": "pzp_id",
 "payload": {
 "status":"registerPzh"
 }
}
</pre>

After PZH is created, auth-status message is again sent but now with authCode and then the PZP responds back with enrollPzp message.

The PZH only responds back to the https request, it does not originates any https request towards the PZP.

PZP Revocation
--------------

### Revocation of personal zone proxies

Within a personal zone, revocation is implemented through a synchronized certificate revocation list (CRL) issued by the personal zone hub. This allows the user to selectively revoke a device by visiting the PZH’s web interface and clicking a `revoke’ button. The CRL is synchronized between devices whenever they connect to the PZH or when any device in zone is revoked.

![]({width:1100px}revocation1.png)
Figure 3: PZP revoke at PZH

All PZPs in a personal zone have a copy of another connected zone’s master certificate. This certificate allows PZPs to connect to the personal zone hub (PZH) of another person. To avoid the capability that a device that no longer belongs to the user A uses its stored certificate to connect to the PZH of user B, every PZH should exchange CRLs with all PZHs they are connected to. A PZP that no longer belongs to the personal zone of user A can then be rejected by the PZH of user B when trying to connect, based on the current revocation list.

### Revocation of personal zone hubs

The user may wish to move their personal zone hub to a different service provider for a number of reasons, such as cost or quality of service. They may also be concerned that their hub provider has been compromised or is behaving maliciously. In both cases the PZH certificates must be revoked so that PZPs cannot connect to the old PZH.

In the normal case, the hosting platform of a personal zone hub MUST provide a publicly accessible CRL or OCSP (Online Certificate Status Protocol) server to invalidate the certificates.

[andrÃ©] what is the personal zone hub provider? how to do PZH certificate revocation without having a PZH provider. For example i have my PZH on my router?. Maybe it should be state something like: A PZPs MUST provide a possibility to revoke the PZH certificate locally.

[JPL] The underlying platform of a personal zone hub - I’ve made changes, but I’m sure this is referred to in plenty of other documentation. You always have a provider - it may be your router.

In the malicious case, the user must assume that their PZH key were compromised, and that the service provider could impersonate them by accepting requests from remote parties. Solving this problem requires disconnecting and updating each personal zone device in turn as well as notifying all external contacts to re-discover the personal zone hub URL from the user’s WebFinger record (or other discovery service). Because this process may be slow and error-prone, we suggest that users should regularly re-discover their contacts.

Much of the security (authenticity) of the personal zone hub comes down to reliance on the OpenID provider and the discovery service which links user identity to the personal zone hub.

[andrÃ©] Don’t understand why this is the case. I thought webinos is secure and not that webinos security relies on third parties.

[JPL] I’m not sure how to address this comment. It does rely on third parties. We’ve been supporting OpenID for a long time. Discovery of a PZH also relies on a third party, there’s no other way of designing it.

PZH Export and Import
---------------------

A PZH Export and Import support the user moving the PZH from a provider to another provider. The import and export will lead to completely new certificate generation for PZP’s. All the current data pertaining to current PZH should be migrated, this data is used for allowing PZP’s to still connect to PZH using older certificate. On connection a new certificates are generated and send to PZP.

### PZH URI

The change impact for the user after migration will be a new URI to access their PZH. For example: webinos.org/alice to serona.org/alice. The user details are not changed but changes are associated to the change in the provider name. The discovery service should be accordingly updated with new PZH URI for the user.

### Migration data

A PZH MUST provide means to import and export the following data.

[andrÃ©] Better to write it more specification requirement like: A PZH must provide means to import and export following PZH data.

[JPL] Done.

[andrÃ©] Is this import/export mandatory for each PZH implementation or is it allowed to not have it?

[JPL] It is mandatory.

-   User policy files
-   Known devices and users: the PZH maintains a list of the devices for which it has generated certificates and other user’s PZHs with which a secure exchange of certificate has happened. This information should also be migrated between PZHs.
-   Revocation list: the PZH holds a list of devices that have been revoked. This list of certificate IDs and devices names should be exported to the new PZH.
-   User profile: Any information relating to user and any other setting should also be exported.

### Export interface

A webinos personal zone hub must support the ability to export data as described in the "Migration data" section.

The PZH must offer export as an option on the web interface. All the information are hold in JSON format and XML (policies). Export should result in the end user downloading a zip file containing the "Migration data" specified above, with the following structure:

[andrÃ©] don’t know if the concrete JSON objects are defined elsewhere but to let this work possible JSON structures (including possible attributes and values) need to be described.

[JPL] Agreed. Forwarding to Habib.

[habib] done

[andrÃ©] Why is it needed to export the OpenID account info? I cannot import at the new PZH when not logged-in anyway? Also i would assume that other authentication schemes are possible to (like electronic identity cards)

[JPL] This isn’t exactly OpenID data, but any addition user account information that may have been collected by a PZH. It’s not about authentication, but it may include preferences or other information.

  -------------------------------------------------------------------------------------------------------------------------------------------------------- ------------------------------------------------------------------------------------------------------
  Path                                                                                                                                                     Content
  "/pzh.json":http://dev.webinos.org/redmine/projects/wp3-3/wiki/Synchronisation#User-details                                                           This file contains the metadata surrounding this PZH - the OpenID accounts it was connected to, etc.
  "/devicelist.json":http://dev.webinos.org/redmine/projects/wp3-3/wiki/Synchronisation##Service-Cache                                                 This file contains the list of known devices and users
  /crl.pem                                                                                                                                                 This file contains the certificate revocation list of the old hub provider
  "/policies/":http://dev.webinos.org/redmine/projects/wp3-3/wiki/Spec_-_Privacy_Policy#Manifests-synchronization-and-usage              This folder contains all XACML policy files
  "/policies/manifests/":http://dev.webinos.org/redmine/projects/wp3-3/wiki/Spec_-_Privacy_Policy#Manifests-synchronization-and-usage    This folder contains applications manifests
  "/policies/exceptions/":http://dev.webinos.org/redmine/projects/wp3-3/wiki/Spec_-_Privacy_Policy#Manifests-synchronization-and-usage   This folder contains policy exception that should not be synchronised across devices
  /certificates/external/                                                                                                                                  This folder contains PEM-encoded certificate files referring to other users’ PZHs and PZPs
  /certificates/internal/pzp/                                                                                                                              This folder contains PEM-encoded certificate files referring to the user’s own PZPs
  /certificates/internal/pzh/                                                                                                                              This folder contains PEM-encoded certificate files referring to the user’s own PZH
  "/userdata/":http://dev.webinos.org/redmine/projects/wp3-3/wiki/Synchronisation#User-preferences                                                      This folder contains any other user profile data
  -------------------------------------------------------------------------------------------------------------------------------------------------------- ------------------------------------------------------------------------------------------------------

The certificate directories hold the pem file for each trusted and untrusted device. The internal folder contains same personal zone device certificates and external folder contains other personal zone certificates. The meta-data related to the trusted device is hold in devicelist.json as described above. The crl.pem holds the crl certificate of the personal zone.

### Import interface

The PZH must support the ability to import data from an old personal zone hub at any time. This may overwrite any existing settings. Hubs must be able to import a zip file as described in the previous section.

### ‘Remove Hub’ option

A PZH must provide the option to remove the hub and delete all the user data residing on it. This must delete all PZH data, but service provides MAY store a backup for up to a month, but this information MUST be disclosed to the user when the PZH is removed.

[andrÃ©] At best this is informative section but really what is the reason for saying one month? What happens if the provider deletes after a year or never? Also i don’t assume that a PZH can remove itself from wherever.

[JPL] This is a specification - I’m specifying ‘up to a month’. Secure deletion is a difficult problem - you have to balance the need to recover data with the need to remove private data from old infrastructure. We can’t enforce this, but we can’t enforce that anyone follows any aspect of the specification - why is this different? I actually think this recommendation would be useful. This specification is for people _implementing_ PZHs, so they need to know this information.

### Certificate and Keys

Once migrated, the PZH will have the new master CA key and related certificates. "PKI":http://dev.webinos.org/redmine/projects/wp3-3/wiki/Personal_Zone_Key_Infrastructure section provides details about the PZH certificates and keys that are generated in webinos.

User preferences option
-----------------------

It comprises of various options that the PZH provides by default and which user can opt out. A PZH must provide following user preferences options:

-   Synchronize items
-   Application data storage

These options effect all the PZP’s and is not target for one particular PZP. If user wishes to select one of the PZP, user preference apply only for that particular PZP.

### Synchronise item options

A PZH must synchronises by default policies, certificates, context object, user preference and user details. The PZH admin shall provide interface for the user to select what default items that should be synchronised between the devices. If the user does not want the policies to be synchronized between the devices, the user can select to opt out.

### Application data storage

A application can store a certain amount of temporary data related to the application such as images or cached data for the news application. If the user wants this to be deleted after end of session with the PZH. This option could be selected, by default application data is stored and not deleted by the PZH.

[andrÃ©] What application stores app data where? What is the use case? If apps using file API shouldn’t file API just provide an option or a path (like temp) that is cleaned after the app is terminated? Why comes the PZH into play here?

[habib] what i intended was a browser kind of functionality, you cache certain data for news application or webpage, for example nytimes.com app downloads news and stores in the cache… PZH does not play any role, it is user prefernce to get global functionality across devices.

