Spec - Authentication and Identity
==================================

{{toc}}

Conceptual Architecture
-----------------------

The authentication and identity mechanisms within webinos form the critical foundations upon which the many of the more sophisticated functions are built.

In the preceding sections the concepts of the personal zone (both hub and proxy) have been explained. In this section the details of the authentication mechanism shall be first gently introduced (in the conceptual architecture section) then formally specified. In deliverable [[Spec_-_Authentication#Webinos-D35|D3.5]] the reasoning behind these architecture decision and threats to security are discussed in detail.

Within webinos, the authentication and identity issues need to be addressed at two distinct levels.

# Intra webinos authentication: the mechanisms via which users and devices are authenticated by the personal zone
# Extra webinos authentication: which describe some utility capability, where the personal zone hub can assist in the authentication against multiple external web applications and services, which are not necessarily webinos based.

We have decided to distinguish these two levels, as within webinos the zone-based authentication integrates perfectly in the architecture and it meets all the authentication requirements. However, on the open Internet, strong authentication which involves a third party to prove the identity of a user is required. Thus different means of authentication will be implemented which can also be used for legally binding agreements on the Internet.

In addition to that, authentication is done in two steps: first the user is authenticated to at least one of his devices. Second the device communicates on behalf of the user identifying itself with its public key and its certificate.

We will deal with intra webinos authentication in this specification. Extra webinos authentication will be dealt with in phase II of the webinos project. But before we do so, let us remind ourselves of the roles and responsibilities of the PZP and PZH, with respect the the authentication and identity problem


**Personal Zone**:

The personal zone is a conceptual entity, that has meaning to an end user, but from an implementation perspective is built up of one (and only one) personal zone hub, and many personal zone proxies.

From end users perspective the personal zone hub has the following qualities:

* Web addressable: the personal zone hub is identified by a unique URI.
* Permanently addressable: the personal zone hub should be "permanently" addressable on the open internet. It is presumed to be highly available.
**** SEC-NOTE: it there fore must be robust to denial of service attacks
* Outgoing messages: the personal zone hub becomes the intelligent agent through which all outgoing webinos messages are proxied, if there is no peer-to-peer communication set-up between two devices after authentication
* Incoming messages: the personal zone hub is the entity to which all incoming messages are directed, and therefore takes responsibility for directing the messages to the right place.
**** in the cases where devices have set-up a peer-to-peer connection, incoming traffic is only routed through the PZH during authentication
* Secure intermediary: the personal zone hub is the end user’s policy enforcement point. It should be aware of and police the end user preferences, with respect to any security relevant action.
* Secure perimeter: as far as the user is concerned, the personal zone hub is a secure perimeter. People, devices and applications that are granted access to the personal zone are presumed to be trusted.
* Authentication: the personal zone hub is the entity against which all devices, users, applications must authenticate (identify) themselves in order to be granted "inter-zone" rights

Each device in the personal zone has its own unique public/private cryptographic key pair. Once the user is authenticated to a device, the device reveals access to the secure storage which keeps the private key in a protected environment. The PZP is the only entity which can access the private key. The PZP uses the private key for mutual authentication within the zone and across zones, and for integrity and confidentiality of communication between devices.

**Personal Zone Hub**:

The personal zone hub, is a server based entity that orchestrates the behaviour all of the personal zone proxies, in order to deliver the functionality expected from the personal zone hub.

The PZH acts as a master repository for critical data that must be synchronised between hub and proxies, in order to deliver the required on-line and off-line functionality.

When being messaged from devices on the open internet, the PZH acts like a DNS server, finding the most relevant end device application, to which the incoming webinos messages should be routed.

The PZH acts as certification authority (CA) for the entire zone. Each device has a certificate which is issued by the PZH once the device joins the zone.

**Personal Zone Proxy**:

An application rarely interacts with the PZH directly, in most cases the application interacts with a PZH via the PZP.

The PZP therefore intercepts and either directly deals with or forwards the authentication requests.

The PZP intercepts and forwards all outgoing messages.

The PZP receives and forwards on all incoming messages

The PZP synchronises key information with the PZH to allow it to perform its functions. This data includes

* critical user identity information (to assist discovery) e.g. email, first name, last name etc
* webinos PZH authentication tokens
* extra webinos, 3rd party service authentication tokens (webinos Phase II)
* identity tokens for trusted devices
* identity tokens for trusted applications
* identity tokens for trusted people
* identity tokens for services that can be accessed from other people
* all policy description files
* context data
* session data
* application data

The webinos-related tokens are represented by certificates. Tokens for 3rd-party services are authorisation tokens which are issued by an identity provider. Synchronisation is performed as soon as a PZP established a secure channel with the PZH and whenever data changes while being connected.


**Intra webinos authentication**

Intra webinos authentication covers all communication within one personal zone or across multiple personal zones. Authentication is always the same. First the user is authenticated to the device. Second the device authenticates to one or more other devices. These other devices can be in the same or in another zone. A device proves its affiliation to a zone by holding a certificate which is issued by the PZH of that zone. In addition, the device possesses the private key of the key pair of which the public key is contained in the certificate.


h3. PZP installation process

The PZP is a fundamental and trusted component of a personal zone. For proper security of the entire persona zone, we must address the issue of how does the PZP get installed upon the device.

The PZP needs to be obtained from a trusted source. The PZH is the most suitable source as it also hosts the user data which is to be synchronised to the PZP later. On the device which is to be joined to the zone, the PZH needs to be identified and authenticated. Thereafter, the PZP is obtained and installed. Before and after installation the integrity of the PZP needs to be validated.

During the installation process, the PZP generates its new and unique public/private key pair. It stores the private key in its secure storage and submits the public key to the PZH. The PZH stores the public key and issues a certificate for the PZP. Once the PZP obtained the certificate, it can prove to other entities that it is a legitimate affiliate of the zone.

Before installation, it is required to be sure that the PZP talks to the desired PZH and vice versa. Similar to the case where communication between two personal zones is set-up, a separate channel is used to verify that the communication end points are the desired ones. First, the user authenticates at the PZH and executes the _add device_ feature there. Second, the user enters the identifier (URI) of the PZH on the new device. Third, the PZH and the new device establish a secure connection via Diffie-Hellman key exchange.

Fourth, the PZH displays a random number which it also sends to the new device. The user has to verify that both are the same. Fifth, the user downloads and installs the PZP as described above. Since the new device may not have a PZP yet, all the steps can be performed in an ordinary Web browser on the new device.

The PZP is conceptually and architecturally distinct from the webinos web runtime. A specific implementation may bind the to element together in a single executable. For a clear delineation of the roles and responsibilities of the PZP and webinos WRT see [[Webinos key architectural components]]

More on bindings between device, PZP and application, as well as attestation and further related topics can be found in the deliverable [[Spec_-_Authentication#Webinos-D35|D3.5]].

### Trusting a web application

A particular web application may be either "in zone" or "out of zone". The first opportunity to trust an application should be at install time. Either the user must be explicitly asked, or there must be a policy rule that states that this application is "zone trusted".

The results of this trusting process, is that the application identifier is placed into the trusted application cache of the PZP which is synchronised with the PZH.

The set of applications that are deemed zone trusted are defined within the policy defintion[[TBD]]

### Identifiers

In webinos devices and applications are identified independently.

#### Application Identifiers

Applications need to be uniquely identified. The application identification mechanisms will be based upon the frameworks discussed in the foundations section. Applications are identified as defined in W3C Widget. The application ID is defined by the developer plus optional developer signatures are possible. Either the raw identifier, or a hashed token based upon the identifier must be stored in the PZP trusted application cache.

#### Device identifier

Each device needs to be uniquely identified. When possible, webinos can exploit already available unique identifiers, e.g.

-   mobile phone
    -   IMEI
    -   IMSI
-   PC
    -   mac address
    -   hard drive ID

If a trusted, uniquely defined device identifier proves impossible to define, PZH can issue a unique identifier at the point of PZP installation.

These identifiers could be useful also for authentication purpose, but should be used in a security-wise process, to ensure protection against fake identifiers. An address is hard to forge only if contains some part of (or derives from) a shared secret. Moreover, even if not easy to forge, it is not completely secure if transferred along an insecure channel or re-used more then one time, since it is exposed to the risk of being sniffed and thus re-used by a malicious user.
For these reasons, for example, Mac addresses and hard drive IDs are not hard to spoof identifiers. However, on the base of the security requirement for the scenario (e.g. it is not a privacy problem to expose universal identifiers) and on the authentication mechanisms (i.e. the identity will be confirmed by some challenges based on a some direct or indirect established trusted relationships, e.g. certificates signed by a trusted third party) the overall architecture remains robust and secure

### User Authentication levels

Within webinos a user will be authenticated to different levels. At least three levels will be supported by default. The policy definition can support more. The supported levels are:

-   Anonymous: the lowest level, where no user authentication has happened. The PZP exist and is running, but it has no idea who is using the device it is on
-   Device inherited authenticated: here it is implied that the PZP has integrated with the authentication mechanism on the device already. For a PC this could be the user name password challenge. For a mobile phone this could be PIN lock. The device inherited level will ascribe a _low_ or _high_ authentication confidence depending upon the mechanisms active
-   Elevated webinos authentication: this is where the PZP directly challenges the user, using the authentication plug-in architecture defined below.

The device inherited authentication carries with it no specification, but a list of recommendations or requirements. These requirements define what is minimally required for inherited authentication in webinos. Any device which wishes to be compliant to webinos MUST implement these requirements. These requirements are:

-   The device has built-in secure storage. Sensitive data, such as the private key of the PZP is stored therein. The secure storage at least MUST encrypt data which is stored there with a strong encryption algorithm and a suitable key length. ASE256 SHOULD be used. The storage SHOULD be a combination of hardware protection and software protection (i.e. encryption). Combining the software protection with tamper-resistant hardware protection (such as the SIM card in a mobile phone) provides the best possible protection of the data and is preferred therefore. For secure storage, see also deliverable [[Spec_-_Authentication#Webinos-D35|D3.5]].
    * There is an easy-to-use remote command to delete the content of the secure storage for the case the device is stolen or lost.
    
    Technically, the remote delete command a the PZH should result in the PZH deleting the cached authentication token of the PZP-device.
    This in turn leads to the PZH-PZP synchronisation deleting the tied authentication tokens
    
    The behaviour of a PZP, is defined so that it its PZH authentication token is deleted, it MUST delete all cached user/PZH data from the cache and revert to an anonymous PZP.
    
    * The device MUST authenticate the user by one or more commonly accepted state-of-the-art authentication mechanism. This authentication MUST prevent unauthorised entities from using the device and from accessing resources thereon. Authentication can be done by any method which is useful and suitable for the device. Examples are:
    **** username and password: the password has to be long enough and complex enough
    **** PIN protection: the PIN has to be long enough and not easy to guess; a low number of maximally permitted attempts is to be set
    **** biometry: a finger print or iris scanner which is difficult to fool.
    **** posession of a token which is attached to the device while using it
    * There MUST NOT be any way to bypass authentication
    * The authentication mechanism implements an interface which is exposed to the PZP, where the PZP can:
    **** request user authentication
    **** determine the state of user authentication (authenticated, not authenticated, method by which the user was authenticated, what time ago the user was authenticated)
    **** event-based notification of user authentication each time the user authenticates without request by the PZP
    * Only the PZP has access to the secure storage
    
    A user always authenticates with one or more of the user’s devices belonging to the personal zone. Any communication performed by the devices happens on behalf of the authenticated user. Devices authenticate themselves as the personal zone, backed by the personal zone’s certificate. If the user is not authenticated, functionality of the device is limited to local applications and to the use of services which do not need authentication. Examples for non-authenticated usage are watching TV, browsing the Internet, listening to locally stored music. As soon as remote webinos services are used or PZH communication is required, the user MUST be authenticated.
    
    An internal plug-in interface will be defined on the PZP (and optional protocols to the PZH) to allow for new webinos authentication mechanisms to be defined.
    
    "JavaScript APIs":http://dev.webinos.org/specifications/draft/authentication.html are defined, to allow an application to both
    
    # query the current authentication level
    # request a (re-)authentication

### Authentication Process

The user authenticates towards the device by means which are provided by the device. Once the user is authenticated, the PZP has access to the private key of the public/private key pair which identifies the device. As soon as the PZH has issued a certificate that proves that the device belongs to the PZH, it implies that the device belongs to the personal zone.

The PZP public/private key pair is generated by the PZP itself, then a certificate request (along with the PZP public key) is submitted to the PZH, which issues a certificate (with the required attributes and the public key of the PZP) signed by PZH private key and give it back to requesting PZP. In this way, the PZP private key never left the local device secure storage, so not exposing this key to chance of disclosure while in transit.

The PZP can then establish a secure communication between itself and the PZP of another device. In webinos — as it is based on Web technologies — there is a TCP connection whenever two devices communicate. On top of this connection, a TLS channel is set-up. This channel authenticates both the endpoints of the communication, and it ensures integrity and confidentiality of the communication. Since the PZP needs its private key to establish the TLS channel, the user has to be authenticated in order to enable access to the secure storage where the private key is stored. On top of this secure communication channel, the application can use any application layer protocol (e.g. HTTP, XMPP, RTP, RTCP).

Once the TLS channel is established, applications can call APIs of services via this channel without the need to deal with authentication. Authentication is completely transparent to the developer. The fact that the TLS channel exists implies that the user is authenticated to at least one of the devices, that the devices belong to the same or to a trusted personal zone and that the devices are authenticated. The policy will take care of access control on the API level.

The same kind of secure communication channel is also set-up between each device’s PZP and the zone’s PZH. This is done by default whenever both the device can reach the PZH and the user is authenticated to the device.

Apart from the TLS protocol, there is no need for additional protocols or messaging for authentication between PZPs or PZP and PZH.

### User identifiers

For user visible identifiers we use:

-   the URI of the PZH, or
-   some piece of data (e.g. the user’s email address) that reliably resolves (e.g. via Webfinger) to a single PZH URI.

Details on webfinger and how it can be used wihtin webinos are to be found in the [[Background_-_Discovery|Background]] and [[Spec_-_Discovery#Discovery-of-Personal-Zone-Hub|Specification]] sections of Discovery in this deliverable.

For the internal implementation of the PZH <-> PZP trusted user cache and synchronisation, the URI which identifies the PZH of a user is mapped to the cryptographic key of the PZP. This is stored in the trusted users cache on the PZP/PZH.

### Trusting new users

Within a webinos personal zone, applications need to be verified against the zone. Devices also need to be verified against the zone, but this is implicit in the PZP installation process described above. The PZH holds a list of installed applications per device. an application is only added to this list if it was installed and verified properly. User consent is required for installation and the security policy needs to permit installation.

Some of the more interesting use cases, however are only possible, when we can communicate between zones. This requires the establishment of trust between zones, i.e. users.

The mechanism via which trust is established between two people is a protocol that requires the permission from both parties in the transaction. First, they need to make sure that their devices (each belonging to one user’s personal zone) are indeed communicating with each other. This is done by verifying the two certificate’s fingerprints via a separate channel (e.g. by reading it out on the phone) or by typing a randomly generated PIN. Second, a secure communication channel is established. Third, if both users accept, the certificates are exchanged and stored in the PZH. When trust has been established between users, then each PZH will cache the other PZH’s certificate in the trusted users cache. This defines the other PZH and thus the entire personal zone as trusted.

Even though a trust relationship exists between two people (i.e. certificates are mutually exchanged), every subsequent communication must still be subject to the security policy in force on both participating personal zones.

The initial step of making sure that the expected devices indeed communicate with each other is supported by webinos’ social relationship concept. Users typically know another already and they also know some of their identifiers (e.g. a phone number, an email address, the nickname in a social network). This information can be used in webinos to reveal the URI of the user’s PZH. The PZH then knows the user’s devices are to be reached. When devices of two users are starting to communicate for the first time, each user has to permit the other user to access the list of devices on the PZH to directly communicate to the given device thereafter. This is a preparatory step for personal zone binding in the case of no local proximity in an easy-to-use manner.

In case of local proximity, personal area network technologies or near field communication can be used to initiate communication of the two devices of the two different zones. For example, Bluetooth, a local wireless network or RFID chips built into the device can be used.

In both cases, social relationship and local proximity, users need to verify that they communicate with the intended devices by exchanging some information via another channel, as described in the process above.

Technical Use Cases
-------------------

The following discrete technical use cases help us understand the precise technology that is required to implement the webinos functionality.

Attached to each use case is a set of sequence diagrams that explores the logical flows and helps describe the implied roles and responsibilities of each architectural entity. Some of the ones presented here (namely, scenario 2, 4 and 9) according to the current architecture are very similar to other cases, so they are no longer discussed here.

### Overview

The activity diagram shows how communication between devices in a zone is bootstrapped once the device is turned on.

<div class="uml">

title Bootstrapping communication in webinos

(**) --> "turn on a device"
--> "authenticate user"
--> "device seeks for networksnto connect to"
if "connected?" then
--> [true] "look up current addressn of the PZH (e.g. by usingn a WebFinger service)"
 note left: webinos WebFinger service is a central servicenon the Internet. For each user, an addressnis stored there if a PZH is activen nIf webinos’ WebFinger service is notnaccessible, the network is not connected tonthe Internet
 --> "accessnPersonal Zone Hub"
 note left: If none of the user’s devices is connected tonthe Internet at present, the WebFinger servicendoes not return an address
 if "accessible?" then
--> [true] "register there andnsync data cache"
 note right: device updates its availabilitynto "online", allowing other devicesnto discover and contact itn ndata cache is a local store on thendevice which keeps data fromnPZH for offline use
 if "registered?" then
 --> [true] "check for other ownndevices which are online" as devcheck
--> "set-up a secure channeln(TLS) for any device found,nif needed" as secureconn
 --> "use any local ornremote service" as uselocremo
--> (**)
 else
 --> [false] "start local discovery ofndevices of the same owner" as locdisc
 endif
 else
--> [false] locdisc
 note right: if the PZH is not accessible,neach devices falls back tonusing its own PZPn n list of own devices is storednin the data cache
 --> "use local services" as uselocal
 if "other ownndevices appear?" then
--> [true] secureconn
 else
 --> [false] uselocal
 endif
 endif
else
--> [false] "only local apps andnservices can be used"
 --> (**)
endif

</div>


The following sequence diagrams describes the logic flow with emphasis on the authentication exchange description. So, the flow is quite at high level in some part. It is expected that to have a full picture, the reader knows other part of this deliverable, in particular Discovery for more precise discovery exchanges, and high level architecture (e.g., for synchronization discussion between PZP and PZH). The service provisioning is just a possible example of service, details of that are out of this section’s scope.

h3. Scenario 1 - Same Personal Zone

George wants to view his mobile hosted MP4s on his set top box and both devices have access to the internet

Assumptions

** George **owns** both devices
* George is going to trigger and control the playback from his mobile device
* The Settop box therefore acts as a slave, and exposes (remotely) stop, playback ffwd, rwd, and status functions
* The data will be streamed from mobile to set top box
* We will assume both devices have access to the public internet

h4. Sequence diagram analysis

<div class=“uml”>(

title Scenario 1nGeorge wants to view his mobile hosted MP4s on his set-top-boxnand both devices have access to the internet

actor George
box "Mobile" #lightgreen
 participant "George’snmobilenWRT" as George_mobile
 participant "George’s mobilenpersonal zonenproxy" as mpzp
end box
participant "George’snpersonalnzone hub" as pzh
box "Set-Top-Box" #FF8888
 participant "George’s set-top-boxnpersonal zonenproxy" as spzp
 participant "George’snset-top-boxnWRT" as George_set_top_box
end box

autonumber

note over George_set_top_box
 We assume George’s
 set-top-box is
 already into the
 personal zone
end note

 identification 

group identification example
 George -> George_mobile : switch on
 George_mobile -> George : ask for the pin
 George -> George_mobile : provide the pin
end

 personal zone join 

note over George, George_set_top_box
 The PZH works as a personal zone certification authority. The first time a device joins
 the personal zone, the user must accept the PZH certificate. Then the device generates a
 keys pair and send his own public key to the PZH to obtain the corresponding certificate
end note

note over George, George_mobile
 The user may set a policy to
 automatically join the personal zone
end note

George_mobile -> mpzp : join the personal zone
mpzp -> pzh : authenticate
pzh -> mpzp : authenticate
note over mpzp, pzh
 Keys from the credential store
 are used for authentication.
 The credential store is cyphered
 and can be unlocked by the user,
 e.g. via a passphrase or a pin
end note
mpzp -> pzh : set-up securencommunication channel
note over mpzp, pzh
 TLS is used for authentication
 and for establishing the secure
 channel
end note
mpzp -> pzh : register online status
note over mpzp, pzh
 device and all the running
 services are registered at
 the PZH
end note
pzh -> mpzp : synchronise localndata cachen(includes device list)
mpzp -> George_mobile : transmit the device list

 connection establishment 

George_mobile -> George : show the device list
George -> George_mobile : select the set-top-box
George_mobile -> mpzp : establish a channelnwith the set-top-box
mpzp -> pzh : check online statusnof the set-top-box
pzh -> mpzp : return online statusnof the set-top-box

note over mpzp, spzp
 We assume Gorge’s mobile and George’s set-top-box
 establish a secure channel using their own certificates
end note

mpzp -> spzp : establish a secure channel

note over mpzp, spzp
 Connection is established between mobile PZP and
 set-top-box PZP, without involve PZH any longer
end note

spzp -> mpzp : connection established
mpzp -> George_mobile: connection established
George_mobile -> George: notify connection

 service provision 

George -> George_mobile : ask for MP4 list

note over George_mobile, George_set_top_box
 Simplified communications. Real communications involve George’s mobile WRT,
 George’s mobile PZP, George’s set-top-box PZP and George’s set-top-box WRT
end note

George_mobile--> George_set_top_box : MP4 list retrieval
George_set_top_box --> George_mobile : MP4 list transmission
George_mobile -> George : MP4 list display
George -> George_mobile : MP4 selection
George_mobile--> George_set_top_box : MP4 retrieval
George_set_top_box --> George_mobile : MP4 transmission
George_mobile -> George : MP4 consumption

</div>


h3. Scenario 2- Across Multiple Personal Zones

George wants to listen to Pauls MP4s on his mobile - mobile to mobile, and both have access to the internet

Assumptions
* There is access to open identity servers on the internet
* This is a sharing scenario: permission must be granted for a resource to be consumed by another person
* This requires both users identity to be attested

#### Sequence diagram analysis

<div class="uml">

title : Scenario 2nGeorge wants to listen to Paul’s MP4s on his mobilenmobile to mobile, and both have access to the internet

actor George
box "George’s Mobile" #lightgreen
 participant "George’snmobilenWRT" as George_mobile
 participant "George’s mobilenpersonalnzone proxy" as gpzp
end box
participant "George’snpersonalnzone hub" as gpzh
participant "Facebook" as fb
participant "Paul’snpersonalnzone hub" as ppzh
box "Paul’s Mobile" #FF8888
 participant "Paul’s mobilenpersonalnzone proxy" as ppzp
 participant "Paul’snmobilenWRT" as Paul_mobile
end box
actor Paul

autonumber

 identification 

group identification example
 George -> George_mobile : switch on
 George_mobile -> George : ask for the pin
 George -> George_mobile : provide the pin
end

 personal zone join 

note over George, Paul
 The PZH works as a personal zone certification authority. The first time a device joins
 the personal zone, the user must accept the PZH certificate. Then the device generates a
 keys pair and send his own public key to the PZH to obtain the corresponding certificate
end note

note over George, George_mobile
 The user may set a policy to
 automatically join the personal zone
end note
George_mobile -> gpzp : join George’s personal zone
gpzp -> gpzh : authenticate

gpzh -> gpzp : authenticate
note over gpzp, gpzh
 Keys from the credential store
 are used for authentication.
 The credential store is cyphered
 and can be unlocked by the user,
 e.g. via a passphrase or a pin
end note
gpzp -> gpzh : set-up securencommunication channel
note over gpzp, gpzh
 TLS is used for authentication
 and for establishing the secure
 channel
end note
gpzp -> gpzh : register online status
note over gpzp, gpzh
 device and all the running
 services are registered at
 the PZH
end note
gpzh -> gpzp : synchronise localndata cache

 connection establishment 

note over George, Paul
 We assume George needs Paul’s PZH URI to access Paul’s personal zone
end note

alt local scenario
 Paul -> George : communicate Paul’s PZH URI
 George -> George_mobile : insert Paul’s PZH URI
else remote scenario - example 1
 autonumber 10
 note over Paul, George
 PZH URI transmitted by Paul ouf of band, e.g. via email
 end note
 Paul -> Paul_mobile : send Paul’s PZH URI
 Paul_mobile -> George_mobile : send Paul’s PZH URI
 George_mobile -> George : display Paul’s PZH URI
 George -> George_mobile : click on Paul’s PZH URI
else remote scenario - example 2
 note over Paul, George
 PZH URI retrieved by George out of band, e.g. via a link on Paul’s Facebook page
 end note
 autonumber 10
 George -> George_mobile : go to Paul’s Facebook page
 George_mobile -> fb : ask for Paul’s page
 fb -> George_mobile : send Paul’s page
 George_mobile -> George : display Paul’s Facebook page
 George -> George_mobile : click on Paul’s PZH URI
end

George_mobile -> gpzp : connect to Paul’s PZH
gpzp -> gpzh : connect to Paul’s PZH

note over gpzh, ppzh
 Each PZH needs to trust the certificate of the
 other PZH. The first time two PZHs establish a
 connection, they must exchange their certificates,
 and ask thei own user if he trust the other PZH
end note

gpzh -> ppzh : send George’s PZH certificate
ppzh -> ppzp : send George’s PZH certificate
ppzp -> Paul_mobile : send George’s PZH certificate
Paul_mobile -> Paul : display George’s PZH certificate
Paul -> Paul_mobile : accept the certificate
Paul_mobile -> ppzp : accept the certificate
ppzp -> ppzh : accept the certificate

ppzh -> gpzh : send Paul’s PZH certificate
gpzh -> gpzp : send Paul’s PZH certificate
gpzp -> George_mobile : send Paul’s PZH certificate
George_mobile -> George : display Paul’s PZH certificate
George -> George_mobile : accept the certificate
George_mobile -> gpzp : accept the certificate
gpzp -> gpzh : accept the certificate

gpzh -> ppzh : authenticate

ppzh -> gpzh : authenticate
note over gpzh, ppzh
 Keys from the credential store
 are used for authentication.
 The credential store is cyphered
 and can be unlocked by the user,
 e.g. via a passphrase or a pin.
 The credential store may include
 previously exchanged certificates
end note
gpzh -> ppzh : set-up securencommunication channel
note over gpzh, ppzh
 TLS is used for authentication
 and for establishing the secure
 channel
end note

gpzh -> gpzp : channel established
gpzp -> George_mobile : channel established

George_mobile -> gpzp : retrieve Paul’s PZH device list
gpzp -> gpzh : retrieve Paul’s PZH device list
gpzh -> ppzh : retrieve Paul’s device list

ppzh -> gpzh : transmit Paul’s device list
gpzh -> gpzp : transmit Paul’s device list

gpzp -> George_mobile : tranmsit Paul’s device list
George_mobile -> George : display Paul’s device list
George -> George_mobile : select Paul’s mobile
George_mobile -> gpzp : estabilish a channelnwith Paul’s mobile
gpzp -> gpzh : estabilish a channelnwith Paul’s mobile

gpzh -> ppzh : estabilish a channelnwith Paul’s mobile
ppzh -> ppzp : estabilish a channelnwith Paul’s mobile

ppzp -> Paul_mobile : estabilish a channelnwith Paul’s mobile
Paul_mobile -> Paul : ask form permission
Paul -> Paul_mobile : grant permission
Paul_mobile -> ppzp : grant permission

note over George_mobile, Paul_mobile
 Connection is established between George mobile PZP and
 Paul mobile PZP, without involve PZH any longer
end note

note over George_mobile, Paul_mobile
 Devices can use previously exchanged
 certificates to estabilish a secure connection
end note

ppzp -> gpzp : connection established
gpzp -> George_mobile : connection established
George_mobile -> George : connection notified

 service provision 

George -> George_mobile : ask for MP4 list

note over George_mobile, Paul_mobile
 Simplified communications. Real communications involve George’s mobile WRT,
 George’s mobile PZP, Paul’s mobile PZP and Paul’s mobile WRT
end note

George_mobile --> Paul_mobile : MP4 list retrival
Paul_mobile -> Paul : ask for MP4 listnsharing permission
Paul -> Paul_mobile : grant temporary permission
Paul_mobile--> George_mobile : MP4 list transmission
George_mobile -> George : MP4 list display

George -> George_mobile : MP4 selection
George_mobile --> Paul_mobile : MP4 retrieval
Paul_mobile -> Paul : ask for MP4 sharing permission
Paul -> Paul_mobile : grant temporary permission
Paul_mobile--> George_mobile : MP4 transmission
George_mobile -> George : MP4 consumption

George -> George_mobile : select another MP4
George_mobile --> Paul_mobile : MP4 retrieval
Paul_mobile--> George_mobile : MP4 transmission
George_mobile -> George : MP4 consumption

</div>
### Scenario 3 - Personal Zone and Service Communication

George has music hosted on a web service, and wants to listen to them on his own mobile device

#### Sequence diagram analysis

<div class="uml">

title : Scenario 3nGeorge has music hosted on a web service,nand wants to listen to them on his own mobile device

actor George
box "George’s Mobile" #lightgreen
 participant "George’snmobilenWRT" as George_mobile
 participant "George’s mobilenpersonalnzone proxy" as pzp
end box
participant "George’snpersonalnzone hub" as pzh
participant "ServicenProvider" as SP

autonumber

 identification 

group identification example
 George -> George_mobile : switch on
 George_mobile -> George : ask for the pin
 George -> George_mobile : provide the pin
end

 personal zone join 

note over George, pzh
 The PZH works as a personal zone certification authority. The first time a device joins
 the personal zone, the user must accept the PZH certificate. Then the device generates a
 keys pair and send his own public key to the PZH to obtain the corresponding certificate
end note

note over George, George_mobile
 The user may set a policy to
 automatically join the personal zone
end note
George_mobile -> pzp : join George’s personal zone
pzp -> pzh : authenticate

pzh -> pzp : authenticate
note over pzp, pzh
 Keys from the credential store
 are used for authentication.
 The credential store is cyphered
 and can be unlocked by the user,
 e.g. via a passphrase or a pin
end note
pzp -> pzh : set-up securencommunication channel
note over pzp, pzh
 TLS is used for authentication
 and for establishing the secure
 channel
end note
pzp -> pzh : register online status
note over pzp, pzh
 device and all the running
 services are registered at
 the PZH
end note
pzh -> pzp : synchronise localndata cache

 authentication 

George -> George_mobile : insert address ofnService Provider (SP)
George_mobile -> pzp : contact the SP
pzp -> pzh : authenticate to SP

note over pzh, SP
 the credentials may be, for example,
 a certificate issued by a trusted
 certification authority
end note
pzh -> SP : send credentials
SP -> pzh : mutual authentication

 service provision 

George -> George_mobile : ask for music list

note over George_mobile, SP
 Simplified communications. Real communications involve
 George’s mobile WRT, George’s mobile PZP and Service Provider
end note

George_mobile --> SP : music list retrieval
SP--> George_mobile : music list transmission
George_mobile -> George : music list display

George -> George_mobile : music file selection
George_mobile --> SP : music file retrieval
SP--> George_mobile : music file transmission
George_mobile -> George : music file consumption

</div>
### Scenario 4 - Service Used by Multiple Zones

George has music hosted on a web service, and wants to listen to it on Paul’s mobile device

#### Sequence diagram analysis

<div class="uml">

title : Scenario 4nGeorge has music hosted on a web service,nand wants to listen to them on his Paul’s mobile device

actor Paul
actor George
box "Paul’s Mobile" #lightgreen
 participant "Paul’snmobilenWRT" as Paul_mobile
 participant "Paul’s mobilenpersonalnzone proxy" as pzp
end box
participant "Paul’snpersonalnzone hub" as ppzh
participant "George’snpersonalnzone hub" as gpzh
participant "ServicenProvider" as SP

autonumber

 identification 

group identification example
 Paul -> Paul_mobile : switch on
 Paul_mobile -> Paul : ask for the pin
 Paul -> Paul_mobile : provide the pin
end

 personal zone join 

note over George, ppzh
 The PZH works as a personal zone certification authority. The first time a device joins
 the personal zone, the user must accept the PZH certificate. Then the device generates a
 keys pair and send his own public key to the PZH to obtain the corresponding certificate
end note

Paul_mobile -> pzp : join Paul’s personal zone
pzp -> ppzh : authenticate

ppzh -> pzp : authenticate
note over pzp, ppzh
 Keys from the credential store
 are used for authentication.
 The credential store is cyphered
 and can be unlocked by the user,
 e.g. via a passphrase or a pin
end note
pzp -> ppzh : set-up securencommunication channel
note over pzp, ppzh
 TLS is used for authentication
 and for establishing the secure
 channel
end note
pzp -> ppzh : register online status
note over pzp, ppzh
 device and all the running
 services are registered at
 the PZH
end note
ppzh -> pzp : synchronise localndata cache

 mobile borrowing 
group identification example
 note over Paul, Paul_mobile : user ID is no more derived from the pin
 Paul -> Paul_mobile : disable automatic ID inheritance
 Paul -> George : borrow mobile
 Paul_mobile -> George : prompt for identity
 George -> Paul_mobile : insert identity
end

 connection establishment 

George -> Paul_mobile : insert George’s PZH URI
Paul_mobile -> pzp : join George’s personal zone
pzp -> ppzh : connect to George’s PZH

note over gpzh, ppzh
 Each PZH needs to trust the certificate of the other PZH.
 George’s PZH must already have Paul’s PZH certificate
 because George is not in his own personal zone, hence
 he can’t accept Paul’s PZH certificate
end note

ppzh -> gpzh : authenticate

gpzh -> ppzh : authenticate
note over ppzh, gpzh
 Keys from the credential store
 are used for authentication.
 The credential store is cyphered
 and can be unlocked by the user,
 e.g. via a passphrase or a pin
end note
ppzh -> gpzh : set-up securencommunication channel
note over ppzh, gpzh
 TLS is used for authentication
 and for establishing the secure
 channel
end note

 authentication 

George -> Paul_mobile : insert address ofnService Provider (SP)
Paul_mobile -> pzp : contact the SP
pzp -> gpzh : authenticate to SP

note over gpzh, SP
 the credentials may be, for example,
 a certificate issued by a trusted
 certification authority
end note
gpzh -> SP : send credentials
SP -> gpzh : mutual authentication

 service provision 

George -> Paul_mobile : ask for music list

note over Paul_mobile, SP
 Simplified communications. Real communications involve
 Paul’s mobile WRT, Paul’s mobile PZP and Service Provider
end note

Paul_mobile --> SP : music list retrieval
SP--> Paul_mobile : music list transmission
Paul_mobile -> George : music list display

George -> Paul_mobile : music file selection
Paul_mobile --> SP : music file retrieval
SP--> Paul_mobile : music file transmission
Paul_mobile -> George : music file consumption

</div>
### Scenario 5 - Multiple Service Usage

George has two different hosted web services that host music - he is playing a playlist which interleave tracks from both services

#### Sequence diagram analysis

<div class="uml">

title : Scenario 5nGeorge has two different hosted web services that host musicnhe is playing a playlist which interleave tracks from both services

actor George
box "George’s Mobile" #lightgreen
 participant "George’snmobilenWRT" as George_mobile
 participant "George’s mobilenpersonalnzone proxy" as pzp
end box
participant "George’snpersonalnzone hub" as pzh
participant "ServicenProvider 1" as SP1
participant "ServicenProvider 2" as SP2

autonumber

note over George, IDP #FF6666
 this scenario differs from scenario 5 in the repetition of authentication
 and service provision phases for the second Service Provider (SP2)
end note

 identification 

group identification example
 George -> George_mobile : switch on
 George_mobile -> George : ask for the pin
 George -> George_mobile : provide the pin
end

 personal zone join 

note over George, pzh
 The PZH works as a personal zone certification authority. The first time a device joins
 the personal zone, the user must accept the PZH certificate. Then the device generates a
 keys pair and send his own public key to the PZH to obtain the corresponding certificate
end note

note over George, George_mobile
 The user may set a policy to
 automatically join the personal zone
end note
George_mobile -> pzp : join George’s personal zone
pzp -> pzh : authenticate

pzh -> pzp : authenticate
note over pzp, pzh
 Keys from the credential store
 are used for authentication.
 The credential store is cyphered
 and can be unlocked by the user,
 e.g. via a passphrase or a pin
end note
pzp -> pzh : set-up securencommunication channel
note over pzp, pzh
 TLS is used for authentication
 and for establishing the secure
 channel
end note
pzp -> pzh : register online status
note over pzp, pzh
 device and all the running
 services are registered at
 the PZH
end note
pzh -> pzp : synchronise localndata cache

 authentication 

George -> George_mobile : insert address ofnService Provider (SP1)
George_mobile -> pzp : contact the SP1
pzp -> pzh : authenticate to SP1

note over pzh, SP1
 the credentials may be, for example,
 a certificate issued by a trusted
 certification authority
end note
pzh -> SP1 : send credentials
SP1 -> pzh : mutual authentication

George -> George_mobile : insert address ofnService Provider (SP2)
George_mobile -> pzp : contact the SP2
pzp -> pzh : authenticate to SP2

note over pzh, SP2
 the credentials may be, for example,
 a certificate issued by a trusted
 certification authority
end note
pzh -> SP2 : send credentials
SP2 -> pzh : mutual authentication

 service provision 

George -> George_mobile : ask for music list

note over George_mobile, SP1
 Simplified communications. Real communications involve
 George’s mobile WRT, George’s mobile PZP and Service Provider 1
end note

George_mobile --> SP1 : music list retrieval
SP1--> George_mobile : music list transmission
George_mobile -> George : music list display

George -> George_mobile : ask for music list

note over George_mobile, SP2
 Simplified communications. Real communications involve
 George’s mobile WRT, George’s mobile PZP and Service Provider 2
end note

George_mobile --> SP2 : music list retrieval
SP2--> George_mobile : music list transmission
George_mobile -> George : music list display

George -> George_mobile : music file selection
George_mobile --> SP1 : music file retrieval
SP1--> George_mobile : music file transmission
George_mobile -> George : music file consumption

George -> George_mobile : music file selection
George_mobile --> SP2 : music file retrieval
SP2--> George_mobile : music file transmission
George_mobile -> George : music file consumption

</div>
### Scenario 6 - Same Personal Zone

George wants to listen to music stored on his mobile, through the set-top box - but this time using the set-top box as the controller

#### Sequence diagram analysis

<div class="uml">

title : Scenario 6nGeorge wants to listen to music stored on his mobile, through the set-top boxnbut this time using the set-top box as the controller

actor George
box "Set-Top-Box" #lightgreen
 participant "George’snset-top-boxnWRT" as George_set_top_box
 participant "George’s set-top-boxnpersonal zonenproxy" as spzp
end box
participant "George’snpersonalnzone hub" as pzh
box "Mobile" #FF8888
 participant "George’s mobilenpersonal zonenproxy" as mpzp
 participant "George’snmobilenWRT" as George_mobile
end box

autonumber

note over George, George_mobile #FF6666
 this scenario differs from scenario 1 in the identification
 phase and in role exchange between set-top-box and mobile
end note

note over George_set_top_box
 We assume George’s
 mobile is already into
 the personal zone
end note

 identification 

group identification example
 George -> George_set_top_box : switch on
 George_set_top_box -> George : prompt for identity
 George -> George_set_top_box : insert identity
end

 personal zone join 

note over George, George_mobile
 The PZH works as a personal zone certification authority. The first time a device joins
 the personal zone, the user must accept the PZH certificate. Then the device generates a
 keys pair and send his own public key to the PZH to obtain the corresponding certificate
end note

note over George, George_set_top_box
 The user may set a policy to
 automatically join the personal zone
end note

George_set_top_box -> spzp : join the personal zone
spzp -> pzh : authenticate
pzh -> spzp : authenticate
note over spzp, pzh
 Keys from the credential store
 are used for authentication.
 The credential store is cyphered
 and can be unlocked by the user,
 e.g. via a passphrase or a pin
end note
spzp -> pzh : set-up securencommunication channel
note over spzp, pzh
 TLS is used for authentication
 and for establishing the secure
 channel
end note
spzp -> pzh : register online status
note over spzp, pzh
 device and all the running
 services are registered at
 the PZH
end note
pzh -> spzp : synchronise localndata cachen(includes device list)
spzp -> George_set_top_box : transmit the device list

 connection establishment 

George_set_top_box -> George : show the device list
George -> George_set_top_box : select the mobile
George_set_top_box -> spzp : estabilish a channelnwith the mobile
spzp -> pzh : check online statusnof the mobile
pzh -> spzp : return online statusnof the mobile

note over spzp, mpzp
 We assume Gorge’s set-top-box and George’s mobile
 establish a secure channel using their own certificates
end note

spzp -> mpzp : estabilish a secure channel

note over spzp, mpzp
 Connection is established between set-top-box PZP and
 mobile PZP, without involve PZH any longer
end note

mpzp -> spzp : connection established
spzp -> George_set_top_box : connection established
George_set_top_box -> George : notify connection

 service provision 

George -> George_set_top_box : ask for MP4 list

note over George_set_top_box, George_mobile
 Simplified communications. Real communications involve George’s set-top-box WRT,
 George’s set-top-box PZP, George’s mobile PZP and George’s mobile WRT
end note

George_set_top_box --> George_mobile : MP4 list retrieval
George_mobile--> George_set_top_box : MP4 list transmission
George_set_top_box -> George : MP4 list display

George -> George_set_top_box : MP4 selection
George_set_top_box --> George_mobile : MP4 retrieval
George_mobile--> George_set_top_box : MP4 transmission
George_set_top_box -> George : MP4 consumption

</div>
Formal Specification
--------------------

This section is where we get into formal specification and architecture

NOTE: when it comes to formal specification the distinctions between the subject areas may collapse

### User Identifiers

#### Specification of friendly identifiers

For the sake of webinos identification, there is a unequivocal relation between the PZH URI and the user who owns the Personal Zone. Not necessarily this device have to be used in all device exchanges, E.g. when anonymity is required, an anonymous identifier could be used. (Anonymous authentication is a webinos phase II issue).

#### Specification of user tokens

X.509 certificates are a typical format of credential tokens. However, webinos does not restrict to this specific format. X.509 certificates are used in a TLS based session to ensure security properties. This is why the webinos specification currently uses X.509 only.

#### User authentication levels

The API by which the status of the user’s authentication level can be determined and by which the user can be (re-)authenticated is specified in deliverable [[Spec_-_Authentication#Webinos-D32|D3.2]] in the "JavaScript APIs":http://dev.webinos.org/specifications/draft/authentication.html section.


h4. Inherited device authentication levels

Applications inherit at most device authentication level, according to least privilege principle. However, when further privilege is required, due to a sensitive function (e.g. access to highly sensitive data), applications can perform a re-authentication (possibly, with a stronger authentication process, e.g. two-factor authentication instead of one-factor).

h4. webinos plugin authentication

Before installation, each webinos component ensure integrity and authenticity thanks to an electronic signature.

h4. Session establishment

Typically, for performance and usability choice, authentication procedure is valid for an entire session. In some circumstances (e.g. access to the critical part of the session) an authentication process could be performed again, to mitigate session hijacking problems.

Session authentication leverages on SSL/TLS security protocols.

h3. User Authentication and Secure Storage

It is up to the developer of the device how to identify and authenticate the user. Any webinos-enabled device MUST meet the security requirements which are discussed in the [[Spec_-_Authentication#User-Authentication-levels|User Authentication Levels]] section above. It is the device manufacturer’s obligation to ensure that user authentication cannot be bypassed.

The device MUST implement the "Authentication API":http://dev.webinos.org/specifications/draft/authentication.html, which allows the PZP and any Web application to query the level of user authentication on the device, to determine if the user is currently authenticated and to explicitly advise the device to (re-)authenticate the user. This function MUST be accessible without any restrictions by the PZP. This function MUST be accessible by any application with prior permission check by the policy. This function SHOULD be implemented in native code for access by the PZP and a wrapper SHOULD be implemented in the WRT for access by the applications via JavaScript.

User authentication MUST be implemented in such a way that the secure storage (which contains the private key of the device, among others) can only be accessed by the PZP and only if the user is authenticated successfully. Once the user is no longer authenticated (e.g. by putting the device in stand-by mode or after some time of inactivity of the user), the user MUST NOT be considered as authenticated any longer and access to the secure storage MUST be blocked. Protection of the secure storage SHALL be a combination of tamper-resistant hardware and encryption. The content of the secure storage SHALL be encrypted by using credentials of the user as (part of) the decryption key. These credentials SHALL only be known to the device while the user is authenticating. Without user authentication there MUST be no way to decrypt the content of the secure storage.

### Personal Zone Proxy (PZP)

The PZP is the component which implements most of the authentication functionality in webinos.

Once the user is authenticated successfully, the PZP is triggered by the device’s user authentication module to perform further authentication. The PZP is triggered by the authentication module in a way that applications cannot do. The PZP MUST NOT be triggered by a message on the network stack, as this message could also originate from an application. Means of IPC are to be used which may vary from device to device and from operating system to operating system. In a Linux environment, PAM is suitable.

Next, the PZP tries to access the PZH over the network. If the PZP reaches the PZH it authenticates and sets-up a secure communication channel for any further communication. The PZP-PZH communication MUST use TLS, MUST use mutual authentication, and MUST perform any communication using the secured TLS-based communication channel. TLS version 1.0 or newer MUST be used. During the handshake phase of the TLS protocol, the PZP MUST send its certificate which was issued by the PZH of the same zone. The PZP MUST verify the certificate which is sent by the PZH during handshake. The certificate of the PZH must be the self-signed certificate of the PZH which is the root certificate of the personal zone. If the PZP cannot validate the certificate or if the certificate is not the expected one, communication MUST be aborted. The PZP SHOULD fall back to initial installation mode, where all the involved certificates are exchanged between PZP and PZH. As soon as the communication channel is establised with TLS, all communication is confidential and integrity of each message is validated. This is done by the TLS implementation. The PZP MUST not negotiate with the PZP and disabling of encryption or integrity validation. Once the TLS-based communication channel is set-up, it is kept alive for any further use until the device is turned off, turned into stand-by mode or the user is logged-off.

The PZP then registers its online status with the PZH. For doing so, the PZP sends a status update message through the established communication channel.

An overview of the format and content of the PZH-PZP communication is to be found at http://dev.webinos.org/redmine/projects/wp3-1/wiki/Webinos_key_architectural_components.

The PZP then synchronises its local data cache with the PZH by using the synchronisation algorithm and protocol specified in the [[Spec_-_Synchronisation|Synchronisation]] section.

Thereafter, the established communication channel is ready for use by any application which wishes to communicate with the PZH or which needs to route traffic through the PZH.

If the PZH is not reachable on the network, the PZP SHOULD try to access the PZH each time when there are changes on the networking. If another network bearer is used, or if the network address changes, or if routing changes, the PZP SHOULD try to access the PZH. If there are no changes on the network, the PZP MAY periodically try to access the PZH. It is up to the device manufacturer to decide the time interval. In general, it is intended to be connected to the PZH as frequent as possible, in order to be reachable via the PZH and in order to keep the data cache synchronised. The time interval SHOULD be balanced between this requirement and power consumption of the device.

If the PZH is not accessible, the PZP is accessible to other PZPs on the local network. The PZP MUST respond to other PZPs who intend to establish communication. The PZP MUST only accept TLS connection with mutual authentication, as described above. Any communication between PZPs MUST use the secure TLS-based communication channel. The PZP must consult its policy to determine which kind of communication is permitted via this communication channel.

In any setting, whenever an application of the device intends to establish any kind of communication with any remote application or service, the PZP MUST intercept this establishment attempt and MUST establish the secure communication channel. Once the secure channel is established, the application can continue establishing its communication. The PZP MUST ensure that all the traffic which is generated by the application/service is exclusively routed through the secure communication channel. It is up to the device manufacturer to decide for how long the established secure channel is to be kept alive. It is also up to the device manufacturer to decide which events will cause an immediate termination of the secure channel. These events MAY be: switching off the device, turning on stand-by mode of the device, logging off the user.


h3. Personal Zone Hub (PZH)

The PZH is the component in the personal zone which organises trust relationships, issues and maintains certificates, establishes communication channels to other devices and performs authentication on behalf of the user.

During the installation process, the PZH has issued a certificate for the PZP. Whenever the PZP is about to establish a communication channel with the PZH, the PZH validates the certificate which is sent by the PZP. The PZP MUST validate the certificate and it MUST verify that it is one of the certificates which was issued by the same PZH. If the certificate was issued by the same PZH, the PZH establishes a TLS connection with mutual authentication. During this authentication process, the PZH MUST send its own self-signed root certificate to the communication peer. If the PZP sends a certificate which is issued by another PZH, the PZH checks if the certificate is stored in the trusted users cache. If it is stored there, the certificate is considered trusted and a TLS connection with this PZP MUST be established. If the certification chain cannot be validated, the PZH MUST not continue communication with the PZP. The PZH MAY enter installation mode or the PZH MAY enter mode in which new certificates are introduced to the PZH and stored in the trusted user cache. Both these modes MUST NOT be entered and MUST NOT be processed without explicit user consent.

The PZH functionality is summarised in the webinos component overview http://dev.webinos.org/redmine/projects/wp3-1/wiki/Webinos_key_architectural_components


h3. Trusting New Users

Establishing trust to another user in webinos means that the PZH stores the certificate of the other user’s PZH in its trusted users cache. This is described above. To better distinguish the two involved PZHs, the PZH of the own personal zone is called _own PZH_ and the PZH of the other user’s personal zone is called _foreign PZH_. The process is as follows:

# Obtain the URI of the foreign PZH. This can be done by asking the user and typing it, by receiving it by any electronic means (e.g. e-mail) or by using Webfinger.
# Initiate a TLS connection with the foreign PZH. Both PZHs determine that they do not trust the certificates which are sent by the peer PZH. Thus initiating the TLS connection is aborted. Both PZHs notify their users that there is a communication attempt. Both PZHs also display the certificate of the peer PZH to the user. The user is prompted for action.
# The user MUST verify the validity of the certificate. This cannot be done automatically, as there might be a DNS spoofing attack or a middle-person attack which would not be detected by automatic means.
## Each user reads out the fingerprint of the certificate of the own PZH.
## The other user compares this fingerprint with the one which is displayed on their PZH. This is the one of the foreign PZH. The users do this via a separate channel, e.g. by telephone or in person, where both users also are convinced that they really talk to the expected person.
## Both users accept the certificate of the peer PZH if the fingerprint is valid and if they intend to communicate with this user. In any other case, the user declines the certificate.
# If the user accepts the certificate, the certificate is stored in the trusted users cache. Since this is a security critical step, the user has to authenticate again in order to perform this step. The PZH MUST require user authentication before storing the certificate in the trusted users cache. The PZP MUST only store the certificate if the user has authenticated successfully.
# The own PZP again tries to establish a TLS connection. THis time, both PZHs know the peer’s certificate. They can mutually authenticate and thus they do establish the TLS connection.
# Now that the TLS connection is established, APIs of devices of the foreign zone can be accessed. The PZP of each of the devices in a zone takes care of access control. The policy defines which resources and APIs the newly trusted user is permitted to access.

The PZH is not required to have a user interface. All the process can be performed by one of the PZPs in the zone. Once the PZP has added the certificate to the trusted users cache, it MUST synchronise the cache with the own PZH.

Note that the policy MAY define that the user is not to be prompted for action in step 2 above. In this case, the PZH MUST terminate communication with the foreign PZH without involving the user. However, if the users intend to establish the trust relationship, they must disable this rule temporarily.


h3. Dependencies on other components

PZP accomplish authentication process on the base of local Policy Infrastructure, in particular interacting with the decision wrapper described in the policy architecture (PZP has also a number of other functions, as described in "Security section":http://dev.webinos.org/redmine/projects/wp3-1/wiki/Spec_-_Security)

### Implementation Architecture

The basic authentication architecture deals with

-   Electronic signature (according to W3C widget signature standard) and correlated cryptographic primitives
-   management of X509 certificate type
-   use of TLS/SSL protocol and correlated ciphersuites
-   XMPP for PZP-PZP and PZP-PZH communication

webinos architecture do not restrict to these security means, but implies them as a baseline

References
----------

### Webinos-D3.2

Webinos Deliverable: D3.2 API Specifications
Officially submitted version
30 June 2011

### Webinos-D3.5

Webinos Deliverable: D3.5 Security Architecture
Officially submitted version
30 June 2011

